<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>View Card Modal</title>

  <!-- Remix Icon CDN for the download glyph -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" />
  <!-- External stylesheet -->
  <link rel="stylesheet" href="../styles/cardGenerated.css" />
  
  <!-- Enhanced AR QR Styling -->
  <style>
    .ar-corner {
      z-index: 10;
      animation: pulse-corner 2s infinite;
      transition: all 0.3s ease;
    }
    
    @keyframes pulse-corner {
      0%, 100% { opacity: 0.7; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.1); }
    }
    
    .qr-placeholder {
      position: relative;
      overflow: visible;
    }
    
    .qr-placeholder canvas {
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .qr-error {
      color: #ff4444;
      font-size: 14px;
      text-align: center;
      padding: 20px;
    }
    
    .ar-indicator {
      animation: glow 2s ease-in-out infinite alternate;
    }
    
    @keyframes glow {
      from { text-shadow: 0 0 5px #007bff; }
      to { text-shadow: 0 0 10px #007bff, 0 0 15px #007bff; }
    }
  </style>
</head>

<body>
  <!-- ===== Modal Overlay ===== -->
  <!-- changed only the wrapper class names so it matches addCard.html -->
    <div class="modal-overlay active" role="dialog" aria-modal="true" aria-labelledby="cardTitle">
        <div class="modal-body">
            <header class="modal-header">
                <h2 id="detailCardName">-</h2>
                <button class="download-btn" aria-label="Download QR">
                    <i class="ri-download-2-line" aria-hidden="true"></i>
                </button>
            </header>            <section class="modal-content">
                <div class="qr-wrapper">
                    <div class="qr-placeholder" role="img" aria-label="AR-ready QR code for business card">
                        <span>Generating QR Code...</span>
                    </div>
                    <div class="qr-info" style="margin-top: 10px; text-align: center; font-size: 12px; color: #ccc;">
                        <p>üì± Point your camera to view in AR</p>
                        <p>üíæ Click download to save QR code</p>
                    </div>
                </div>

                <div class="details">                    <div class="details personalDetails">
                        <ul>
                            <li><span class="label">Card Type</span> <span class="value" id="detailCardType">‚Äî</span></li>
                            <li><span class="label">First Name</span>  <span class="value" id="detailFirstName">‚Äî</span></li>
                            <li><span class="label">Last Name</span>   <span class="value" id="detailLastName">‚Äî</span></li>
                            <li><span class="label">Middle Name</span> <span class="value" id="detailMiddleName">‚Äî</span></li>
                            <li><span class="label">Suffix</span>      <span class="value" id="detailSuffix">‚Äî</span></li>
                            <li><span class="label">Profession</span>  <span class="value" id="detailProfession">‚Äî</span></li>
                            <li><span class="label">Email Address</span> <span class="value" id="detailEmail">‚Äî</span></li>
                            <li><span class="label">Contact&nbsp;No.</span> <span class="value" id="detailContact">‚Äî</span></li>
                            <li class="address-row"><span class="label">Address</span> <span class="value" id="detailAddress">‚Äî</span></li>
                        </ul>
                    </div><div class="details corporateDetails">
                        <ul>
                            <li><span class="label">Card Type</span> <span class="value" id="detailCardTypeCorp">‚Äî</span></li>
                            <li><span class="label">Company Name</span> <span class="value" id="detailCompany">‚Äî</span></li>
                            <li><span class="label">Company Email</span> <span class="value" id="detailCompanyEmail">‚Äî</span></li>
                            <li><span class="label">Contact Person</span> <span class="value" id="detailContactPerson">‚Äî</span></li>
                            <li><span class="label">First Name</span>  <span class="value" id="detailFirstNameCorp">‚Äî</span></li>
                            <li><span class="label">Last Name</span>   <span class="value" id="detailLastNameCorp">‚Äî</span></li>
                            <li><span class="label">Middle Name</span> <span class="value" id="detailMiddleNameCorp">‚Äî</span></li>
                            <li><span class="label">Suffix</span>      <span class="value" id="detailSuffixCorp">‚Äî</span></li>
                            <li><span class="label">Position</span>    <span class="value" id="detailPosition">‚Äî</span></li>
                            <li><span class="label">Contact&nbsp;No.</span> <span class="value" id="detailContactCorp">‚Äî</span></li>
                            <li class="address-row"><span class="label">Address</span> <span class="value" id="detailAddressCorp">‚Äî</span></li>
                        </ul>
                    </div>
                </div>
            </section>

            <footer class="modal-footer">
                <button class="close-btn" aria-label="Close modal">Close</button>
            </footer>
        </div>
    </div>    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
// Enhanced QR Code Generator for AR-Ready Business Cards
class HoloCardQRGenerator {
  constructor() {
    this.qrInstance = null;
    this.cardData = null;
    this.qrContainer = document.querySelector('.qr-placeholder');
  }  // Generate enhanced AR-ready QR code
  generateARQR(cardData) {
    this.cardData = cardData;
    
    if (!this.qrContainer) {
      console.error('‚ùå QR container not found');
      return;
    }

    // Clear existing QR code and markers
    this.qrContainer.innerHTML = '';

    // Create simple card ID QR for easy scanning
    const qrData = this.createARData(cardData);
    
    try {
      this.generateQRCode(qrData);
      console.log('‚úÖ Simple QR Code generated with card ID:', qrData);
      
      // Setup download functionality
      this.setupDownload();
      
      // Add AR marker corners for visual indication
      this.addARMarkers();
      
    } catch (error) {
      console.error('‚ùå QR Generation failed:', error);
      this.qrContainer.innerHTML = '<div class="qr-error">QR Generation Failed<br>Please try again</div>';
    }
  }
  // Generate the actual QR code
  generateQRCode(data) {
    this.qrInstance = new QRCode(this.qrContainer, {
      text: data,
      width: 200,
      height: 200,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.M, // Medium correction for simple data
      margin: 3 // Add margin for better detection
    });
  }

  // Create reduced AR data for large datasets
  createReducedARData(cardData) {
    const reducedData = {
      type: "holocard-ar",
      version: "1.0",
      cardId: cardData.HoloCardID || cardData.id || Date.now(),
      profile: {
        name: cardData.CardName || this.buildName(cardData),
        email: cardData.Email || cardData.email || '',
        contact: cardData.ContactNo || cardData.contactNo || ''
      },
      webUrl: `${window.location.origin}/holocard_nonext/viewCard.html?id=${cardData.HoloCardID || cardData.id}`,
      generated: new Date().toISOString()
    };
    return JSON.stringify(reducedData);
  }
  // Create simple QR data with just card ID for easy scanning
  createARData(cardData) {
    // Simple format - just the card ID for fastest scanning
    const cardId = cardData.HoloCardID || cardData.id || Date.now();
    return cardId.toString();
  }

  // Alternative: Minimal JSON format (if you need structure)
  createStructuredARData(cardData) {
    const cardId = cardData.HoloCardID || cardData.id || Date.now();
    return JSON.stringify({
      id: cardId,
      type: "holocard"
    });
  }

  // Legacy: Create full data (for backward compatibility)
  createFullARData(cardData) {
    const arData = {
      // AR Marker Identification
      type: "holocard-ar",
      version: "1.0",
      
      // Card Identity
      cardId: cardData.HoloCardID || cardData.id || Date.now(),
        // Personal/Corporate Information
      profile: {
        name: cardData.CardName || this.buildName(cardData),
        cardType: cardData.CardTypeText || cardData.cardType || 'Personal',
        email: cardData.Email || cardData.email || '',
        contact: cardData.ContactNo || cardData.contactNo || '',
        address: cardData.Address || cardData.address || '',
        profession: cardData.Profession || cardData.profession || '',
        position: cardData.Position || cardData.position || ''
      },
      
      // Company Information (if corporate)
      company: cardData.CardTypeText === 'Corporate' ? {
        name: cardData.CompanyName || cardData.company || '',
        email: cardData.CompanyEmail || cardData.companyEmail || '',
        contact: cardData.CompanyContact || cardData.companyContact || '',
        contactPerson: this.buildContactPersonName(cardData),
        position: cardData.Position || cardData.position || ''
      } : null,
      
      // AR Configuration
      ar: {
        markerType: "qr",
        markerSize: 0.1, // 10cm real-world size
        trackingMode: "stable",
        renderDistance: 2.0 // 2 meters max detection
      },
      
      // Web Fallback
      webUrl: `${window.location.origin}/holocard_nonext/viewCard.html?id=${cardData.HoloCardID || cardData.id}`,
      
      // Timestamp for caching
      generated: new Date().toISOString()
    };

    return JSON.stringify(arData);
  }
  // Build full name from parts
  buildName(cardData) {
    if (cardData.CardName) return cardData.CardName;
    
    const parts = [
      cardData.firstName || cardData.FirstName || '',
      cardData.middleName || cardData.MiddleName || '',
      cardData.lastName || cardData.LastName || ''
    ].filter(part => part.trim());
    
    return parts.join(' ') || 'Unknown';
  }

  // Build contact person name for corporate cards  // Build contact person name for corporate cards
  buildContactPersonName(cardData) {
    const parts = [
      cardData.ContactPerson_FirstName || cardData.contactFirstName || cardData.firstName || cardData.FirstName || '',
      cardData.ContactPerson_LastName || cardData.contactLastName || cardData.lastName || cardData.LastName || ''
    ].filter(part => part.trim());
    
    const fullName = parts.join(' ');
    const suffix = cardData.ContactPerson_Suffix || cardData.contactSuffix || cardData.suffix || cardData.Suffix || '';
    
    return fullName ? (suffix ? `${fullName} ${suffix}` : fullName) : '‚Äî';
  }
  // Add visual AR marker indicators
  addARMarkers() {
    setTimeout(() => {
      const canvas = this.qrContainer.querySelector('canvas');
      if (canvas) {
        // Add corner markers to indicate AR capability
        const container = canvas.parentElement;
        container.style.position = 'relative';
        
        // Create corner markers with enhanced styling
        const corners = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];
        corners.forEach(corner => {
          const marker = document.createElement('div');
          marker.className = `ar-corner ${corner}`;
          marker.style.cssText = `
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #007bff;
            ${corner.includes('top') ? 'top: -5px;' : 'bottom: -5px;'}
            ${corner.includes('left') ? 'left: -5px;' : 'right: -5px;'}
            ${corner.includes('top') && corner.includes('left') ? 'border-right: none; border-bottom: none;' : ''}
            ${corner.includes('top') && corner.includes('right') ? 'border-left: none; border-bottom: none;' : ''}
            ${corner.includes('bottom') && corner.includes('left') ? 'border-right: none; border-top: none;' : ''}
            ${corner.includes('bottom') && corner.includes('right') ? 'border-left: none; border-top: none;' : ''}
          `;
          container.appendChild(marker);
        });

        // Add enhanced AR indicator text with glow effect
        const arIndicator = document.createElement('div');
        arIndicator.innerHTML = 'üì± AR Ready - Scan with HoloCard App';
        arIndicator.className = 'ar-indicator';
        arIndicator.style.cssText = `
          position: absolute;
          bottom: -35px;
          left: 50%;
          transform: translateX(-50%);
          font-size: 12px;
          color: #007bff;
          font-weight: bold;
          text-align: center;
          white-space: nowrap;
        `;
        container.appendChild(arIndicator);
        
        console.log('‚úÖ AR markers added with enhanced styling');
      }
    }, 100);
  }

  // Setup download functionality
  setupDownload() {
    const downloadBtn = document.querySelector('.download-btn');
    if (downloadBtn) {
      downloadBtn.addEventListener('click', (e) => {
        e.preventDefault();
        this.downloadQR();
      });
    }
  }

  // Download QR code as PNG
  downloadQR() {
    try {
      const canvas = this.qrContainer.querySelector('canvas');
      if (canvas) {
        const link = document.createElement('a');
        const fileName = `holocard-ar-qr-${this.cardData?.HoloCardID || Date.now()}.png`;
        link.download = fileName;
        link.href = canvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('‚úÖ QR Code downloaded:', fileName);
      } else {
        console.error('‚ùå Canvas not found for download');
      }
    } catch (error) {
      console.error('‚ùå Download failed:', error);
    }
  }
  // Populate card details in modal
  populateCardDetails(cardData) {
    const isPersonal = (cardData.CardTypeText || cardData.cardType) === 'Personal';
    
    // Show appropriate details section
    const personalDetails = document.querySelector('.personalDetails');
    const corporateDetails = document.querySelector('.corporateDetails');
    
    if (personalDetails) personalDetails.style.display = isPersonal ? 'block' : 'none';
    if (corporateDetails) corporateDetails.style.display = isPersonal ? 'none' : 'block';

    // Update card name in header
    const cardNameEl = document.getElementById('detailCardName');
    if (cardNameEl) {
      cardNameEl.textContent = cardData.CardName || this.buildName(cardData) || 'HoloCard';
    }    // Update personal detail fields
    const personalFieldMappings = {
      'detailCardType': cardData.CardTypeText || cardData.cardType,
      'detailFirstName': cardData.firstName || cardData.FirstName || cardData.CardName?.split(' ')[0],
      'detailLastName': cardData.lastName || cardData.LastName || cardData.CardName?.split(' ')[1],
      'detailMiddleName': cardData.middleName || cardData.MiddleName,
      'detailSuffix': cardData.suffix || cardData.Suffix,
      'detailProfession': cardData.Profession || cardData.profession,
      'detailEmail': cardData.Email || cardData.email,
      'detailContact': cardData.ContactNo || cardData.contactNo,
      'detailAddress': cardData.Address || cardData.address
    };    // Update corporate detail fields
    const corporateFieldMappings = {
      'detailCardTypeCorp': cardData.CardTypeText || cardData.cardType,
      'detailCompany': cardData.CompanyName || cardData.company,
      'detailCompanyEmail': cardData.CompanyEmail || cardData.companyEmail,
      'detailContactPerson': this.buildContactPersonName(cardData),
      'detailFirstNameCorp': cardData.ContactPerson_FirstName || cardData.contactFirstName || cardData.firstName || cardData.FirstName,
      'detailLastNameCorp': cardData.ContactPerson_LastName || cardData.contactLastName || cardData.lastName || cardData.LastName,
      'detailMiddleNameCorp': '‚Äî', // Not available in database
      'detailSuffixCorp': cardData.ContactPerson_Suffix || cardData.contactSuffix || cardData.suffix || cardData.Suffix,
      'detailPosition': cardData.Position || cardData.position,
      'detailContactCorp': cardData.ContactNo || cardData.contactNo,
      'detailAddressCorp': cardData.Address || cardData.address
    };

    // Apply the appropriate field mappings
    const fieldMappings = isPersonal ? personalFieldMappings : corporateFieldMappings;
    
    Object.entries(fieldMappings).forEach(([elementId, value]) => {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = value || '‚Äî';
      }
    });
  }
}

// Initialize QR Generator
const qrGenerator = new HoloCardQRGenerator();

// Global function for external calls
window.generateHoloCardQR = function(cardData) {
  qrGenerator.populateCardDetails(cardData);
  qrGenerator.generateARQR(cardData);
};

// Handle direct URL loading (for testing)
document.addEventListener('DOMContentLoaded', function() {
  // Keyboard support
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const closeBtn = document.querySelector('.close-btn');
      if (closeBtn) closeBtn.click();
    }
  });

  // Check for URL parameters
  const params = new URLSearchParams(window.location.search);
  if (params.has('data')) {
    try {
      const cardData = JSON.parse(params.get('data'));
      window.generateHoloCardQR(cardData);
    } catch (error) {
      console.error('‚ùå Failed to parse URL data:', error);
      
      // Fallback: generate simple QR from URL data
      const qrContainer = document.querySelector('.qr-placeholder');
      if (qrContainer) {
        qrContainer.innerHTML = '';
        new QRCode(qrContainer, {
          text: params.get('data'),
          width: 180,
          height: 180,
          correctLevel: QRCode.CorrectLevel.H
        });
      }
    }
  }

  // Enhanced close button functionality
  const closeBtn = document.querySelector('.close-btn');
  if (closeBtn) {
    closeBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const modal = document.querySelector('.modal-overlay');
      if (modal) {
        modal.classList.remove('active');
        
        setTimeout(function() {
          // Remove from DOM
          if (modal.parentNode) {
            modal.parentNode.removeChild(modal);
          }
          
          // Clear modal container
          const modalContainer = document.getElementById('modalContainer');
          if (modalContainer) {
            modalContainer.innerHTML = '';
          }
          
          console.log('‚úÖ Modal closed and cleaned up');
        }, 300);
      }
    });
  }

  // Click outside to close
  const modalOverlay = document.querySelector('.modal-overlay');
  if (modalOverlay) {
    modalOverlay.addEventListener('click', function(e) {
      if (e.target === modalOverlay) {
        const closeBtn = document.querySelector('.close-btn');
        if (closeBtn) closeBtn.click();
      }
    });
  }
});
</script>
</body>
</html>
