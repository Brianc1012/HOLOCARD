<!DOCTYPE html>
<html>
<head>
    <title>Final Verification - Edit Functionality</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .btn { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #0056b3; }
        .test-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .test-card { padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß HoloCard Edit Functionality - Final Verification</h1>
        
        <div class="status info">
            <strong>Status:</strong> Testing the complete edit functionality flow after fixes
        </div>
        
        <div class="test-grid">
            <div class="test-card">
                <h3>1. Database Connection</h3>
                <button class="btn" onclick="testDatabase()">Test Database</button>
                <div id="dbResult"></div>
            </div>
            
            <div class="test-card">
                <h3>2. Update API</h3>
                <button class="btn" onclick="testUpdateAPI()">Test Update API</button>
                <div id="apiResult"></div>
            </div>
            
            <div class="test-card">
                <h3>3. Edit Modal Structure</h3>
                <button class="btn" onclick="testModalStructure()">Test Modal</button>
                <div id="modalResult"></div>
            </div>
            
            <div class="test-card">
                <h3>4. Form Submission</h3>
                <button class="btn" onclick="testFormSubmission()">Test Form</button>
                <div id="formResult"></div>
            </div>
        </div>
        
        <div class="test-card">
            <h3>5. End-to-End Test</h3>
            <button class="btn" onclick="runCompleteTest()">Run Complete Test</button>
            <div id="completeResult"></div>
        </div>
        
        <div class="test-card">
            <h3>6. Go to Main App</h3>
            <button class="btn" onclick="window.open('./pages/holocards.html', '_blank')">Open Main App</button>
        </div>
    </div>
    
    <script>
        async function testDatabase() {
            const result = document.getElementById('dbResult');
            try {
                const response = await fetch('./api/get_cards.php?uid=1');
                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML = `<div class="status success">‚úÖ Database connected, ${data.cards.length} cards found</div>`;
                } else {
                    result.innerHTML = `<div class="status error">‚ùå Database error: ${data.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="status error">‚ùå Connection failed: ${error.message}</div>`;
            }
        }
        
        async function testUpdateAPI() {
            const result = document.getElementById('apiResult');
            const testData = {
                cardId: 1,
                cardType: 'Personal',
                firstName: 'Test',
                lastName: 'User',
                email: 'test@example.com',
                contactNo: '1234567890',
                address: 'Test Address'
            };
            
            try {
                const response = await fetch('./api/update_card.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML = `<div class="status success">‚úÖ Update API working correctly</div>`;
                } else {
                    result.innerHTML = `<div class="status error">‚ùå API error: ${data.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="status error">‚ùå API test failed: ${error.message}</div>`;
            }
        }
        
        async function testModalStructure() {
            const result = document.getElementById('modalResult');
            try {
                const response = await fetch('./modals/editCard.html');
                const html = await response.text();
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const modal = doc.querySelector('.modal-overlay');
                
                if (!modal) {
                    result.innerHTML = `<div class="status error">‚ùå Modal overlay not found</div>`;
                    return;
                }
                
                const checks = {
                    'Form element': modal.querySelector('#editCardForm'),
                    'Save button': modal.querySelector('#editCardButton'),
                    'Cancel button': modal.querySelector('.cancelButton'),
                    'Category select': modal.querySelector('#editCardCategory'),
                    'Personal section': modal.querySelector('.personalDetails'),
                    'Corporate section': modal.querySelector('.corporateDetails')
                };
                
                let allGood = true;
                let details = '';
                
                Object.entries(checks).forEach(([name, element]) => {
                    if (element) {
                        details += `‚úÖ ${name}<br>`;
                    } else {
                        details += `‚ùå ${name}<br>`;
                        allGood = false;
                    }
                });
                
                // Check if category select is inside form
                const form = modal.querySelector('#editCardForm');
                const categoryInForm = form && form.contains(modal.querySelector('#editCardCategory'));
                
                if (categoryInForm) {
                    details += `‚úÖ Category select is inside form<br>`;
                } else {
                    details += `‚ùå Category select is NOT inside form<br>`;
                    allGood = false;
                }
                
                if (allGood) {
                    result.innerHTML = `<div class="status success">‚úÖ Modal structure correct<br>${details}</div>`;
                } else {
                    result.innerHTML = `<div class="status error">‚ùå Modal structure issues<br>${details}</div>`;
                }
                
            } catch (error) {
                result.innerHTML = `<div class="status error">‚ùå Modal test failed: ${error.message}</div>`;
            }
        }
        
        async function testFormSubmission() {
            const result = document.getElementById('formResult');
            try {
                const response = await fetch('./modals/editCard.html');
                const html = await response.text();
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const modal = doc.querySelector('.modal-overlay');
                
                document.body.appendChild(modal);
                modal.dataset.cardId = '1';
                
                const form = modal.querySelector('#editCardForm');
                const saveButton = modal.querySelector('#editCardButton');
                
                if (!form || !saveButton) {
                    result.innerHTML = `<div class="status error">‚ùå Form or button not found</div>`;
                    return;
                }
                
                // Fill form with test data
                modal.querySelector('#editCardCategory').value = 'Personal';
                modal.querySelector('#editFName').value = 'Test';
                modal.querySelector('#editLname').value = 'User';
                modal.querySelector('#editEmail').value = 'test@example.com';
                modal.querySelector('#editContact').value = '1234567890';
                modal.querySelector('#editAddress').value = 'Test Address';
                
                // Test form submission
                let formSubmitted = false;
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    formSubmitted = true;
                });
                
                // Trigger form submission
                saveButton.click();
                
                setTimeout(() => {
                    if (formSubmitted) {
                        result.innerHTML = `<div class="status success">‚úÖ Form submission working</div>`;
                    } else {
                        result.innerHTML = `<div class="status error">‚ùå Form submission not triggered</div>`;
                    }
                    modal.remove();
                }, 100);
                
            } catch (error) {
                result.innerHTML = `<div class="status error">‚ùå Form test failed: ${error.message}</div>`;
            }
        }
        
        async function runCompleteTest() {
            const result = document.getElementById('completeResult');
            result.innerHTML = `<div class="status info">üîÑ Running complete test...</div>`;
            
            try {
                // Step 1: Check if we have cards
                const cardsResponse = await fetch('./api/get_cards.php?uid=1');
                const cardsData = await cardsResponse.json();
                
                if (!cardsData.success || cardsData.cards.length === 0) {
                    result.innerHTML = `<div class="status error">‚ùå No cards available for testing</div>`;
                    return;
                }
                
                const testCard = cardsData.cards[0];
                
                // Step 2: Load modal
                const modalResponse = await fetch('./modals/editCard.html');
                const modalHtml = await modalResponse.text();
                const doc = new DOMParser().parseFromString(modalHtml, 'text/html');
                const modal = doc.querySelector('.modal-overlay');
                
                document.body.appendChild(modal);
                modal.dataset.cardId = testCard.HoloCardID;
                
                // Step 3: Fill form
                const isPersonal = testCard.CardTypeText === 'Personal';
                modal.querySelector('#editCardCategory').value = isPersonal ? 'Personal' : 'Corporate';
                
                if (isPersonal) {
                    modal.querySelector('#editFName').value = 'Updated';
                    modal.querySelector('#editLname').value = 'Name';
                    modal.querySelector('#editEmail').value = 'updated@test.com';
                    modal.querySelector('#editContact').value = '9876543210';
                } else {
                    modal.querySelector('#editCompany').value = 'Updated Company';
                    modal.querySelector('#editCompanyEmail').value = 'updated@company.com';
                    modal.querySelector('#editCompanyContact').value = '9876543210';
                }
                
                modal.querySelector('#editAddress').value = 'Updated Address';
                
                // Step 4: Submit form
                const form = modal.querySelector('#editCardForm');
                const saveButton = modal.querySelector('#editCardButton');
                
                const updateData = {
                    cardType: modal.querySelector('#editCardCategory').value,
                    firstName: modal.querySelector('#editFName')?.value || '',
                    lastName: modal.querySelector('#editLname')?.value || '',
                    company: modal.querySelector('#editCompany')?.value || '',
                    email: modal.querySelector(isPersonal ? '#editEmail' : '#editCompanyEmail')?.value || '',
                    contactNo: modal.querySelector(isPersonal ? '#editContact' : '#editCompanyContact')?.value || '',
                    address: modal.querySelector('#editAddress')?.value || '',
                    cardId: testCard.HoloCardID
                };
                
                const updateResponse = await fetch('./api/update_card.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                const updateResult = await updateResponse.json();
                
                if (updateResult.success) {
                    result.innerHTML = `
                        <div class="status success">
                            ‚úÖ Complete test SUCCESSFUL!<br>
                            Card ${testCard.HoloCardID} updated successfully
                        </div>
                        <pre>${JSON.stringify(updateData, null, 2)}</pre>
                    `;
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Test Complete!',
                        text: 'All edit functionality is working correctly',
                        confirmButtonText: 'Great!'
                    });
                } else {
                    result.innerHTML = `<div class="status error">‚ùå Update failed: ${updateResult.error}</div>`;
                }
                
                modal.remove();
                
            } catch (error) {
                result.innerHTML = `<div class="status error">‚ùå Complete test failed: ${error.message}</div>`;
            }
        }
        
        // Auto-run basic tests
        window.addEventListener('load', async () => {
            await new Promise(resolve => setTimeout(resolve, 500));
            testDatabase();
            await new Promise(resolve => setTimeout(resolve, 1000));
            testModalStructure();
        });
    </script>
</body>
</html>
