<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scanner</title>  <link rel="stylesheet" href="../styles/scanner.css" />
  <!-- Load A-Frame -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>

  <!-- Load AR.js AFTER A-Frame -->
  <script src="https://cdn.jsdelivr.net/gh/jeromeetienne/ar.js@3.3.2/aframe/build/aframe-ar.min.js"></script>

  <!-- Load jsQR for QR code detection -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script src="../scripts/scanner.js" defer></script>
  <script>
    // Debug log: HTML loaded
    console.log('[scanner.html] HTML loaded, DOMContentLoaded event will be fired soon.');
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[scanner.html] DOMContentLoaded event fired.');
      // Log AR.js and A-Frame presence
      if (window.AFRAME) {
        console.log('[scanner.html] A-Frame loaded:', window.AFRAME);
      } else {
        console.error('[scanner.html] A-Frame NOT loaded!');
      }
      if (window.ARjs) {
        console.log('[scanner.html] AR.js loaded:', window.ARjs);
      } else {
        console.warn('[scanner.html] AR.js not found as window.ARjs (may be normal for aframe-ar.js)');
      }
      // Log AR scene and marker presence
      const arScene = document.getElementById('arScene');
      const arMarker = document.getElementById('arMarker');
      const arCardInfo = document.getElementById('arCardInfo');
      if (arScene) {
        console.log('[scanner.html] AR scene found:', arScene);
      } else {
        console.error('[scanner.html] AR scene NOT found!');
      }
      if (arMarker) {
        console.log('[scanner.html] AR marker found:', arMarker);
      } else {
        console.error('[scanner.html] AR marker NOT found!');
      }
      if (arCardInfo) {
        console.log('[scanner.html] AR card info entity found:', arCardInfo);
      } else {
        console.error('[scanner.html] AR card info entity NOT found!');
      }
      // DEBUG: Log when scan area overlay is present
      const scanArea = document.getElementById('scanAreaOverlay');
      if (scanArea) {
        console.log('[scanner.html] Scan area overlay found:', scanArea);
      } else {
        console.warn('[scanner.html] Scan area overlay NOT found!');
      }
      // Camera test: try to access camera and log result
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // Prefer environment camera, but allow fallback to any camera
        const constraints = {
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        };
        navigator.mediaDevices.getUserMedia(constraints)
          .then(function(stream) {
            console.log('[CAMERA TEST] Camera access: SUCCESS', stream);
            // Stop the stream immediately after test
            stream.getTracks().forEach(track => track.stop());
          })
          .catch(function(err) {
            // Fallback: try any camera if environment fails
            console.warn('[CAMERA TEST] Environment camera failed, trying any camera...', err);
            navigator.mediaDevices.getUserMedia({ video: true })
              .then(function(stream) {
                console.log('[CAMERA TEST] Fallback camera access: SUCCESS', stream);
                stream.getTracks().forEach(track => track.stop());
              })
              .catch(function(err2) {
                console.error('[CAMERA TEST] Camera access: FAILED', err2);
              });
          });
      } else {
        console.error('[CAMERA TEST] navigator.mediaDevices.getUserMedia not supported');
      }
    });
  </script>
</head>
<body>
  <div class="scannerPageContainer">
    <div class="backandlabel">
      <button class="backButton" onclick="window.location.href='../pages/menuPage.html'">Back</button>
      <h1 class="AppName">HoloCard</h1>
    </div>

    <h1 class="label">Scanner</h1>

    <div class="scannerContainer">
      <!-- Camera Preview (AR Scene) -->
      <div class="camScanner">
        <div class="arSceneContainer" style="width:100%;height:640px;min-height:400px;position:relative;">
          <div id="scanAreaOverlay" style="position:absolute;top:50%;left:50%;width:180px;height:180px;transform:translate(-50%,-50%);border:2.5px dashed #00ffae;border-radius:18px;box-shadow:0 0 16px #00ffae55;pointer-events:none;z-index:10;transition:border-color 0.2s;">
            <div style="position:absolute;top:-2.5px;left:-2.5px;width:24px;height:24px;border-top:4px solid #00ffae;border-left:4px solid #00ffae;border-radius:8px 0 0 0;"></div>
            <div style="position:absolute;top:-2.5px;right:-2.5px;width:24px;height:24px;border-top:4px solid #00ffae;border-right:4px solid #00ffae;border-radius:0 8px 0 0;"></div>
            <div style="position:absolute;bottom:-2.5px;left:-2.5px;width:24px;height:24px;border-bottom:4px solid #00ffae;border-left:4px solid #00ffae;border-radius:0 0 0 8px;"></div>
            <div style="position:absolute;bottom:-2.5px;right:-2.5px;width:24px;height:24px;border-bottom:4px solid #00ffae;border-right:4px solid #00ffae;border-radius:0 0 8px 0;"></div>
          </div>
          <a-scene
            embedded
            vr-mode-ui="enabled: false"
            arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
            renderer="logarithmicDepthBuffer: true; antialias: true; colorManagement: true; sortObjects: true;"
            id="arScene"
            style="width:100%;height:100%;"
          >
            <!-- Use pattern-based marker that can track any QR-like pattern -->
            <a-marker type="pattern" preset="custom" url="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" 
                      smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5"
                      id="arMarker">
              <!-- Card info will be injected here by scanner.js -->
              <a-entity id="arCardInfo"></a-entity>
            </a-marker>
            <a-entity camera look-controls="enabled: false" cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
          </a-scene>
        </div>
        <div id="scanStatus" style="width:100%;text-align:center;margin-top:0.5rem;font-size:1rem;color:#fff;font-family:'Poppins',sans-serif;letter-spacing:0.05rem;min-height:1.5em;">
          Ready to scan...
        </div>        <!-- Scanned Info (now below camera preview) -->
        <div class="scannedDetails wide">
          <h1 class="scannedDetailsLabel">Scanned Details</h1>
          <div class="photoLogoContainer">
            <img src="../public/images/holocardLogo.svg" alt="Logo" class="photoLogo" />
          </div>
          <div class="details details-grid">
            <div class="details-row">
              <span class="detailsLabel" id="cardType">Card Type: None</span>
              <button class="copy-btn" data-copy-target="cardType" title="Copy">ðŸ“‹</button>
            </div>
            <div class="details-row">
              <span class="detailsLabel" id="company">Company: None</span>
              <button class="copy-btn" data-copy-target="company" title="Copy">ðŸ“‹</button>
            </div>
            <div class="details-row">
              <span class="detailsLabel" id="contactPerson">Contact Person: None</span>
              <button class="copy-btn" data-copy-target="contactPerson" title="Copy">ðŸ“‹</button>
            </div>
            <div class="details-row">
              <span class="detailsLabel" id="name">Name: None</span>
              <button class="copy-btn" data-copy-target="name" title="Copy">ðŸ“‹</button>
            </div>
            <div class="details-row">
              <span class="detailsLabel" id="email">Email: None</span>
              <button class="copy-btn" data-copy-target="email" title="Copy">ðŸ“‹</button>
            </div>
            <div class="details-row">
              <span class="detailsLabel" id="contact">Contact Number: None</span>
              <button class="copy-btn" data-copy-target="contact" title="Copy">ðŸ“‹</button>
            </div>
            <div class="details-row">
              <span class="detailsLabel" id="professionPosition">Profession/Position: None</span>
              <button class="copy-btn" data-copy-target="professionPosition" title="Copy">ðŸ“‹</button>
            </div>            <div class="details-row">
              <span class="detailsLabel" id="address">Address: None</span>
              <button class="copy-btn" data-copy-target="address" title="Copy">ðŸ“‹</button>
            </div>
          </div>
          <!-- Add to Contacts Button -->
          <div class="add-contact-container" id="addContactContainer" style="display: none;">
            <button class="add-contact-btn" id="addContactBtn">
              <span class="btn-icon">ðŸ‘¤</span>
              <span class="btn-text">Add to Contacts</span>
            </button>
          </div>
        </div>
      </div>
      <!-- AR overlay is handled by scanner.js and .details -->
    </div>
  </div>
</body>
</html>
