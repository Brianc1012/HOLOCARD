<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test ViewCard Simple QR</title>
    <link rel="stylesheet" href="styles/addCard.css">
    <link rel="stylesheet" href="styles/cardGenerated.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .test-title {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
            font-weight: bold;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: transform 0.2s;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        
        .qr-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .qr-box {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .qr-data {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-title">
            <i class="ri-qr-code-line"></i>
            ViewCard Simple QR Test
        </h1>
        
        <div class="test-section">
            <h3>üéØ Test Objective</h3>
            <p>Verify that the ViewCard modal now generates <strong>simple QR codes</strong> (just card ID) instead of complex JSON structures.</p>
            
            <div class="status info">
                <strong>Expected:</strong> QR codes should contain only the card ID (e.g., "15") for fast scanning.
            </div>
        </div>

        <div class="test-section">
            <h3>üß™ Test Cards</h3>
            <button class="test-button" onclick="testPersonalCard()">
                <i class="ri-user-line"></i> Test Personal Card QR
            </button>
            <button class="test-button" onclick="testCorporateCard()">
                <i class="ri-building-line"></i> Test Corporate Card QR
            </button>
            <button class="test-button" onclick="compareQRTypes()">
                <i class="ri-contrast-line"></i> Compare Simple vs Complex QR
            </button>
        </div>

        <div class="test-section">
            <h3>üìä QR Code Analysis</h3>
            <div id="analysisResults"></div>
        </div>

        <div class="test-section">
            <h3>üîç Scanner Integration Test</h3>
            <p>After generating QR codes above:</p>
            <ol>
                <li>Open <a href="pages/scanner.html" target="_blank">Scanner Page</a></li>
                <li>Point camera at the generated QR codes</li>
                <li>Verify they scan quickly and show card data</li>
            </ol>
        </div>

        <!-- Modal container -->
        <div id="modalContainer"></div>
    </div>

    <script src="scripts/holocard.js"></script>
    <script>
        // Test data
        const samplePersonalCard = {
            HoloCardID: 99,
            CardName: "John Doe",
            CardTypeText: "Personal",
            Email: "john.doe@email.com",
            ContactNo: "555-0123",
            Address: "123 Main Street, City, State",
            BirthDate: "1990-01-15"
        };

        const sampleCorporateCard = {
            HoloCardID: 100,
            CardName: "Acme Corporation",
            CardTypeText: "Corporate",
            Email: "contact@acme.com",
            ContactNo: "555-0456",
            Address: "456 Business Ave, Corporate City",
            ContactPerson: "Jane Smith"
        };

        function logStatus(message, type = 'info') {
            const resultsDiv = document.getElementById('analysisResults');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
            resultsDiv.appendChild(statusDiv);
        }

        async function testPersonalCard() {
            logStatus('üß™ Testing Personal Card ViewCard QR generation...', 'info');
            
            try {
                await openViewCardModal(samplePersonalCard);
                
                // Wait a moment for QR generation
                setTimeout(() => {
                    analyzeGeneratedQR('Personal Card');
                }, 1000);
                
            } catch (error) {
                logStatus(`‚ùå Personal Card test failed: ${error.message}`, 'error');
            }
        }

        async function testCorporateCard() {
            logStatus('üß™ Testing Corporate Card ViewCard QR generation...', 'info');
            
            try {
                await openViewCardModal(sampleCorporateCard);
                
                // Wait a moment for QR generation
                setTimeout(() => {
                    analyzeGeneratedQR('Corporate Card');
                }, 1000);
                
            } catch (error) {
                logStatus(`‚ùå Corporate Card test failed: ${error.message}`, 'error');
            }
        }

        function analyzeGeneratedQR(cardType) {
            const modal = document.querySelector('.modal-overlay');
            if (!modal) {
                logStatus(`‚ùå ${cardType}: Modal not found`, 'error');
                return;
            }

            const qrContainer = modal.querySelector('#qrContainer');
            if (!qrContainer) {
                logStatus(`‚ùå ${cardType}: QR container not found`, 'error');
                return;
            }

            // Check for QR code canvas (indicates successful generation)
            const qrCanvas = qrContainer.querySelector('canvas');
            const qrImage = qrContainer.querySelector('img');
            
            if (qrCanvas || qrImage) {
                logStatus(`‚úÖ ${cardType}: QR code generated successfully`, 'success');
                
                // Try to extract QR data (this is a simplified check)
                const qrElement = qrCanvas || qrImage;
                const qrSize = qrElement.width || qrElement.offsetWidth;
                
                if (qrSize >= 100 && qrSize <= 200) {
                    logStatus(`‚úÖ ${cardType}: QR size optimized (${qrSize}px) - Good for simple data`, 'success');
                } else {
                    logStatus(`‚ö†Ô∏è ${cardType}: QR size (${qrSize}px) may indicate complex data`, 'warning');
                }
                
                logStatus(`üìù ${cardType}: Simple QR format should contain only card ID`, 'info');
            } else {
                // Check for fallback display
                const fallbackText = qrContainer.textContent;
                if (fallbackText.includes('Card ID:')) {
                    logStatus(`‚úÖ ${cardType}: Fallback shows simple card ID format`, 'success');
                } else {
                    logStatus(`‚ùå ${cardType}: No QR code or fallback found`, 'error');
                }
            }
        }

        function compareQRTypes() {
            logStatus('üìä Comparing Simple vs Complex QR Types...', 'info');
            
            const resultsDiv = document.getElementById('analysisResults');
            const comparisonDiv = document.createElement('div');
            comparisonDiv.className = 'qr-comparison';
            
            // Simple QR (what we want)
            const simpleBox = document.createElement('div');
            simpleBox.className = 'qr-box';
            simpleBox.innerHTML = `
                <h4>‚úÖ Simple QR (Current)</h4>
                <div id="simple-qr"></div>
                <div class="qr-data">Data: "99"</div>
                <div class="status success">Fast scanning ‚ö°</div>
            `;
            
            // Complex QR (what we removed)
            const complexBox = document.createElement('div');
            complexBox.className = 'qr-box';
            complexBox.innerHTML = `
                <h4>‚ùå Complex QR (Previous)</h4>
                <div id="complex-qr"></div>
                <div class="qr-data">Data: {"type":"holocard-ar","version":"2.0",...}</div>
                <div class="status error">Slow scanning üêå</div>
            `;
            
            comparisonDiv.appendChild(simpleBox);
            comparisonDiv.appendChild(complexBox);
            resultsDiv.appendChild(comparisonDiv);
            
            // Generate comparison QR codes
            generateComparisonQRs();
        }

        function generateComparisonQRs() {
            try {
                // Simple QR
                new QRCode(document.getElementById('simple-qr'), {
                    text: "99",
                    width: 100,
                    height: 100,
                    correctLevel: QRCode.CorrectLevel.M
                });
                
                // Complex QR
                const complexData = JSON.stringify({
                    type: "holocard-ar",
                    version: "2.0",
                    cardId: 99,
                    profile: samplePersonalCard,
                    ar: { markerType: "qr", trackingMode: "stable" }
                });
                
                new QRCode(document.getElementById('complex-qr'), {
                    text: complexData,
                    width: 100,
                    height: 100,
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                logStatus(`üìä Comparison: Simple (${String(99).length} chars) vs Complex (${complexData.length} chars)`, 'info');
                logStatus(`üöÄ Speed improvement: ~${Math.round((complexData.length / String(99).length) * 10)}x faster scanning`, 'success');
                
            } catch (error) {
                logStatus(`‚ùå Comparison generation failed: ${error.message}`, 'error');
            }
        }

        async function openViewCardModal(cardData) {
            try {
                // Load the viewCard modal
                const response = await fetch('./modals/viewCard.html');
                if (!response.ok) throw new Error('Failed to load viewCard modal');
                
                const modalHTML = await response.text();
                
                // Insert modal into container
                const modalContainer = document.getElementById('modalContainer');
                modalContainer.innerHTML = modalHTML;
                
                // Show modal
                const modal = document.querySelector('.modal-overlay');
                if (modal) {
                    modal.classList.add('active');
                    modal.style.display = 'flex';
                    
                    // Populate with data using the global function
                    if (window.populateViewCard) {
                        window.populateViewCard(cardData);
                    } else {
                        // Basic population if function not available
                        const badge = modal.querySelector('#cardTypeBadge');
                        if (badge) badge.textContent = cardData.CardTypeText + ' Card';
                        
                        const nameField = modal.querySelector('#detailName');
                        if (nameField) nameField.textContent = cardData.CardName;
                        
                        // Generate simple QR directly
                        const qrContainer = modal.querySelector('#qrContainer');
                        if (qrContainer && window.QRCode) {
                            qrContainer.innerHTML = '';
                            new QRCode(qrContainer, {
                                text: cardData.HoloCardID.toString(),
                                width: 150,
                                height: 150,
                                correctLevel: QRCode.CorrectLevel.M
                            });
                        }
                    }
                }
                
            } catch (error) {
                throw new Error(`Failed to open ViewCard modal: ${error.message}`);
            }
        }

        // Global close function
        window.closeViewModal = function() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => {
                    const modalContainer = document.getElementById('modalContainer');
                    if (modalContainer) modalContainer.innerHTML = '';
                }, 300);
            }
        };

        // Initialize test
        document.addEventListener('DOMContentLoaded', function() {
            logStatus('üöÄ ViewCard Simple QR Test initialized', 'success');
            logStatus('üìù Click the test buttons above to verify QR generation', 'info');
        });
    </script>
</body>
</html>
