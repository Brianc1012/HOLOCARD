<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Fetch Simulation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .log {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .ar-overlay {
            position: fixed;
            background: rgba(255,255,255,0.98);
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            font-family: 'Segoe UI', sans-serif;
            box-shadow: 0 8px 32px rgba(0,0,0,0.25);
            backdrop-filter: blur(10px);
            max-width: 300px;
            z-index: 1000;
            display: none;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Scanner Fetch Simulation</h1>
        <p>This simulates exactly what the scanner.js does when fetching card data.</p>
        
        <button onclick="simulateScannerFetch('17')">Simulate Scanner Fetch ID 17</button>
        <button onclick="simulateScannerFetch('1')">Simulate Scanner Fetch ID 1</button>
        <button onclick="clearConsole()">Clear Console</button>
        
        <div id="status" class="status"></div>
        <div id="console" class="log"></div>
        <div id="arOverlay" class="ar-overlay"></div>
    </div>

    <script>
        // Global variables to simulate scanner state
        let scanningState = 'idle';
        let currentCardDisplayed = null;
        let arOverlay = null;

        function log(message) {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            console.textContent += `[${timestamp}] ${message}\n`;
            console.scrollTop = console.scrollHeight;
        }

        function setScanStatus(message, color) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.backgroundColor = color;
            status.style.color = color === '#fff' ? '#000' : '#fff';
            log(`Status: ${message}`);
        }

        function setScanningState(newState) {
            log(`[STATE] Changing from ${scanningState} to ${newState}`);
            scanningState = newState;
            
            switch (newState) {
                case 'idle':
                    setScanStatus('Scanning...', '#fff');
                    currentCardDisplayed = null;
                    break;
                case 'fetching':
                    setScanStatus('Fetching card data...', '#00ffae');
                    break;
                case 'displaying':
                    setScanStatus('Scanned!', '#00ffae');
                    break;
            }
        }

        function esc(str) {
            if (str == null) return '';
            return String(str).replace(/[&<>"']/g, function(match) {
                const escapes = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#x27;'
                };
                return escapes[match];
            });
        }

        function showARCard(data, qrLocation = null, qrCorners = null) {
            log('[OVERLAY] Showing AR card with data: ' + JSON.stringify(data, null, 2));
            
            if (!arOverlay) {
                arOverlay = document.getElementById('arOverlay');
            }
            
            const cardName = data.CardName || 'Unknown';
            const cardType = data.CardTypeText || 'Unknown';
            
            arOverlay.innerHTML = `
                <h2 style="color:#2d3748;font-weight:bold;margin:0 0 8px 0;font-size:18px;">${esc(cardName)}</h2>
                <div style="color:#6a11cb;font-weight:600;margin-bottom:12px;font-size:14px;">${esc(cardType)}</div>
                <div style="color:#4a5568;margin:4px 0;font-size:13px;"><strong style="color:#2d3748;">Email:</strong> ${esc(data.Email)}</div>
                <div style="color:#4a5568;margin:4px 0;font-size:13px;"><strong style="color:#2d3748;">Contact:</strong> ${esc(data.ContactNo)}</div>
                <div style="color:#4a5568;margin:4px 0;font-size:13px;"><strong style="color:#2d3748;">Address:</strong> ${esc(data.Address)}</div>
            `;
            
            arOverlay.style.display = 'block';
            log('[OVERLAY] AR overlay displayed successfully');
        }

        // This is the exact fetchCardDataById function from scanner.js
        function fetchCardDataById(cardId, qrLocation = null, qrCorners = null) {
            log(`[API] Starting fetch for card ID: ${cardId}`);
            
            // Set state to fetching
            setScanningState('fetching');
            
            // Use correct API path based on current location
            const currentPath = window.location.pathname;
            let apiPath;
            if (currentPath.includes('/pages/')) {
                // We're in pages directory, go up one level
                apiPath = `../api/get_cards.php?id=${encodeURIComponent(cardId)}`;
            } else {
                // We're in root directory
                apiPath = `api/get_cards.php?id=${encodeURIComponent(cardId)}`;
            }
            
            log(`[API] Current path: ${currentPath}`);
            log(`[API] Using API path: ${apiPath}`);
            
            fetch(apiPath)
                .then(res => {
                    log(`[API] Response status: ${res.status} ${res.statusText}`);
                    if (!res.ok) {
                        // Try alternative path if first fails
                        const altPath = currentPath.includes('/pages/') ? 
                            `../api/get_cards.php?id=${encodeURIComponent(cardId)}` : 
                            `/holocard_nonext/api/get_cards.php?id=${encodeURIComponent(cardId)}`;
                        log(`[API] Trying alternative path: ${altPath}`);
                        return fetch(altPath);
                    }
                    return res;
                })
                .then(res => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    return res.json();
                })
                .then(data => {
                    log(`[API] Raw response: ${JSON.stringify(data, null, 2)}`);
                    
                    // Handle the updated API response format
                    let card = null;
                    if (data.success && data.card) {
                        // Single card response (new format)
                        card = data.card;
                        log('[API] Using single card response format');
                    } else if (data.success && data.cards && data.cards.length > 0) {
                        // Array response (fallback)
                        card = data.cards[0];
                        log('[API] Using array response format');
                    } else if (Array.isArray(data)) {
                        // Direct array response (legacy)
                        card = data[0] || null;
                        log('[API] Using direct array format');
                    } else if (typeof data === 'object' && data !== null && !data.success) {
                        // Direct object response (legacy)
                        card = data;
                        log('[API] Using direct object format');
                    }      
                    
                    if (!card) {
                        throw new Error(`Card not found. Response: ${JSON.stringify(data)}`);
                    }
                    
                    log(`[API] Final card data to display: ${JSON.stringify(card, null, 2)}`);
                    currentCardDisplayed = cardId;
                    showARCard(card, qrLocation, qrCorners);
                    
                    // Set state to displaying
                    setScanningState('displaying');
                })
                .catch(err => {
                    log(`[API] Failed to fetch card data: ${err.message}`);
                    setScanStatus(`Error: ${err.message}`, '#ff4e4e');
                    
                    // Resume scanning on error after a short delay
                    setTimeout(() => {
                        setScanningState('idle');
                    }, 2000);
                });
        }

        function simulateScannerFetch(cardId) {
            log(`\n=== STARTING SCANNER SIMULATION FOR CARD ID ${cardId} ===`);
            fetchCardDataById(cardId);
        }

        function clearConsole() {
            document.getElementById('console').textContent = '';
            const overlay = document.getElementById('arOverlay');
            overlay.style.display = 'none';
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            log('Scanner simulation ready');
            setScanningState('idle');
        });
    </script>
</body>
</html>
